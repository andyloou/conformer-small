model:
  features_extractor_params:
    global_cmvn_path: null
  num_mel_bins: 80
  subsampling_channel: 176
  subsampling_dropout: 0.1
  type_encoder: 'conformer'
  type_decoder: 'transformer'
  sinusoidal_pos_enc_style: add
  position_dropout: 0.1
  encoder_params:
    d_model: 176
    n_layers: 16
    nhead: 4
    dropout: 0.1
    conv_kernel_size: 31
    conv_mult: 1
    ffn_mult: 4
    pre_norm: True
  ctc_weight: 1.0
  ctc_linear_dropout: 0.1
  
  # ===== TĂNG DATA AUGMENTATION =====
  freq_masks: 3                    # ← Tăng từ 2
  time_masks: 10                   # ← Tăng từ 5
  freq_width: 30                   # ← Tăng từ 27
  time_width: 0.1                  # ← Tăng từ 0.05
  
  decoder_params:
    n_layers: 1
    d_model: 176
    n_head: 4
    dropout: 0.1
    pre_norm: True
  label_smoothing_weight: 0.0
  label_smoothing_normalize_length: false

preprocessor:
  sample_rate: 16000
  normalize: per_feature
  window_size: 0.025
  window_stride: 0.01
  window: hann
  features: 80
  n_fft: 512
  log: true
  frame_splicing: 1
  dither: 1.0e-05
  pad_to: 0
  pad_value: 0.0

dataset:
  use_huggingface: true
  dataset_name: "linhtran92/viet_bud500"
  max_duration: 15.0
  target_sampling_rate: 16000
  
  bpe_model_path: data/bpe_2000/bpe.model
  
  batch_size: 32                   # ← Giảm từ 64 (stability)
  num_worker: 12

train:
  output_dir: exps/bud500/conformer_phase1
  
  # ===== CRITICAL: PHASE 1 SETTINGS =====
  freeze_encoder: true             # ← KEY: Freeze encoder
  resume_mode: "selective"         # ← Load encoder từ pretrained English
  debug_lr: true
  debug freeze: true               # ← DEBUG: In trạng thái freeze
  num_epoch: 15                    # ← Phase 1: 15 epochs
  
  # ===== LR SETTINGS (WarmupLR) =====
  lr: 0.0005                       # ← Base LR (peak sau warmup)
  warmup_steps: 2000               # ← Giảm mạnh từ 10000
  weight_decay: 1.0e-5             # ← Regularization
  
  acc_steps: 4                     # ← Giảm từ 8 (update thường hơn)
  
  # ===== MIXED PRECISION =====
  use_amp: false                   # ← TẮT trong phase 1 (debug dễ hơn)
  
  # ===== PRETRAINED PATH =====
  pretrained_path: /home/andyloou/conformer-small/vietasr/model_weights.pth
  
  wandb_config:
    project: bud500-asr-phase1
    tag: conformer-freeze-encoder-v2

# train:
#   output_dir: exps/bud500/conformer_phase2
  
#   # ===== CRITICAL: PHASE 2 SETTINGS =====
#   freeze_encoder: false            # ← UNFREEZE encoder
#   resume_mode: "full"              # ← Load cả encoder + decoder từ phase 1
  
#   num_epoch: 50                    # ← Phase 2: 50 epochs
  
#   # ===== DIFFERENTIAL LR =====
#   encoder_lr: 5.0e-6               # ← Encoder pretrained: LR rất nhỏ
#   decoder_lr: 1.0e-4               # ← Decoder: LR vừa phải
#   other_lr: 5.0e-5                 # ← Spec_aug, batch_norm
  
#   warmup_steps: 5000               # ← Tăng lại warmup
#   weight_decay: 1.0e-6
  
#   acc_steps: 8                     # ← Tăng lại
  
#   # ===== MIXED PRECISION =====
#   use_amp: true                    # ← BẬT lại AMP (decoder đã stable)
  
#   # ===== RESUME FROM PHASE 1 =====
#   pretrained_path: exps/bud500/conformer_phase1/valid_loss_best.pt
  
#   wandb_config:
#     project: bud500-asr-phase2
#     tag: conformer-unfreeze-encoder-v2
decode:
  beam_size: 1
  kenlm_path: null
  word_vocab_path: data/word_vocab.txt
  kenlm_alpha: 0.5
  kenlm_beta: 1.5